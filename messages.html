<!DOCTYPE html>
<html>
<head>
  <title>Admin Chats</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
   html, body {
  height: 100%;
  margin: 0;
  background: #c9d6e5; /* Match index/chat blueish background */
}
body {
  font-family: 'Segoe UI', Arial, sans-serif;
  min-height: 100vh;
  height: 100vh;
  margin: 0;
}
#wrapper {
  display: flex;
  flex-direction: row;
  height: 100vh;
  max-width: 100vw;
  background: #f7f9fa; /* index/chat main bg */
}
#sidebar {
  width: 230px;
  background: #3574e7; /* index/chat blue */
  color: #fff;
  display: flex;
  flex-direction: column;
  min-width: 120px;
  position: relative;
  box-shadow: 2px 0 12px #3574e72c;
}
#sidebarHeader {
  background: #3574e7;
  position: sticky;
  top: 0;
  z-index: 30;
  padding: 0;
  border-radius: 0 0 13px 0;
  box-shadow: 0 1px 6px #3574e725;
}
#sidebar h2 {
  margin: 0;
  font-size: 21px;
  padding: 17px 16px 10px 16px;
  letter-spacing: 1px;
  color: #fff;
  font-weight: 700;
  text-shadow: 0 2px 6px #3574e71a;
}
#sidebarSearchBar {
  display: flex;
  align-items: center;
  padding: 6px 8px;
  background: #2554a7;
  border-radius: 0 0 12px 12px;
  position: sticky;
  top: 54px;
  z-index: 29;
}
#sidebarSearchInput {
  flex: 1;
  padding: 8px 12px;
  border-radius: 16px;
  border: none;
  font-size: 15px;
  outline: none;
  background: #fff;
  color: #222;
  box-shadow: 0 1px 4px #3574e710;
}
#chatList {
  flex: 1;
  overflow-y: auto;
  background: #3574e7;
  border-radius: 0 0 14px 0;
  min-height: 0;
}
.chatItem {
  padding: 12px 16px;
  border-bottom: 1px solid #ffffff19;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  gap: 2px;
  background: transparent;
  transition: background 0.2s;
}
.chatItem.active, .chatItem:hover {
  background: #2554a7;
}
.chatName {
  font-weight: bold;
  font-size: 15px;
  color: #fff;
}
.lastMsg {
  font-size: 12px;
  color: #d0e4fa;
  margin-top: 1px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 170px;
}
.badge {
  background: #25d366;
  color: #fff;
  border-radius: 11px;
  padding: 1px 8px;
  font-size: 12px;
  margin-left: 7px;
  margin-top: 2px;
  align-self: flex-end;
  font-weight: bold;
  box-shadow: 0 1px 3px #3574e72c;
}
#chatArea {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-width: 0;
  background: #f7f9fa;
  height: 100vh;
  position: relative;
}
#header {
  background: #3574e7;
  color: #fff;
  padding: 14px 18px 8px 18px;
  font-size: 19px;
  border-radius: 0 0 14px 14px;
  min-height: 48px;
  position: sticky;
  top: 0;
  z-index: 20;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  box-shadow: 0 2px 10px #3574e78a;
}
#chatWith {
  font-weight: bold;
  color: #fff;
  font-size: 1.08em;
  margin-bottom: 4px;
}
#msgSearchBar {
  width: 100%;
  display: flex;
  align-items: center;
  background: #2554a7;
  padding: 6px 8px;
  box-sizing: border-box;
  border-radius: 0 0 12px 12px;
  position: sticky;
  top: 54px;
  z-index: 19;
}
#msgSearchInput {
  flex: 1;
  padding: 8px 12px;
  border-radius: 16px;
  border: none;
  font-size: 15px;
  outline: none;
  background: #fff;
  color: #222;
  box-shadow: 0 1px 4px #3574e710;
}
#messages {
  flex: 1;
  overflow-y: auto;
  padding: 16px 6px 8px 6px;
  background: #e2e6ef; /* index/chat content bg */
  display: flex;
  flex-direction: column;
  min-height: 0;
}
.msgRow {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  margin-bottom: 6px;
}
.mine {
  align-items: flex-end;
}
.msgBubble {
  background: #fff;
  border-radius: 16px 16px 4px 16px;
  padding: 9px 13px;
  font-size: 15px;
  max-width: 80vw;
  word-break: break-word;
  box-shadow: 0 2px 6px #3574e74a;
  position: relative;
  color: #1d2636;
  border: 1px solid #e2e6ef;
  transition: background 0.2s;
}
.mine .msgBubble {
  background: #c6e6ff;
  border-radius: 16px 4px 16px 16px;
  color: #1d2636;
  border: 1px solid #b2d4f7;
}
.meta {
  font-size: 11px;
  color: #5e89d8;
  margin-top: 2px;
  margin-right: 2px;
  margin-left: 6px;
}
.mine .meta {
  text-align: right;
  margin-left: 0;
  margin-right: 6px;
  color: #3574e7;
}
#inputBar {
  display: flex;
  align-items: center;
  padding: 7px 2px 7px 4px;
  background: #fff;
  border-radius: 14px 14px 0 0;
  gap: 7px;
  position: sticky;
  bottom: 0;
  z-index: 30;
  box-shadow: 0 -1px 5px #3574e710;
  border-top: 1px solid #e2e6ef;
}
#messageInput {
  flex: 1;
  padding: 8px;
  border-radius: 16px;
  border: 1px solid #bbb;
  font-size: 14px;
  outline: none;
  background: #f7f9fa;
  color: #1d2636;
  transition: border 0.18s;
}
#messageInput:focus {
  border: 1.5px solid #3574e7;
  background: #fff;
}
#sendBtn {
  background: #3574e7;
  color: #fff;
  border: none;
  padding: 6px 14px;
  border-radius: 14px;
  font-size: 14px;
  cursor: pointer;
  font-weight: bold;
  transition: background 0.21s;
  box-shadow: 0 2px 6px #3574e731;
}
#sendBtn:active, #sendBtn:hover {
  background: #2554a7;
}
#noChat {
  color: #888;
  text-align: center;
  font-size: 18px;
  margin: 40px 0 0 0;
}
@media (max-width: 650px) {
  #wrapper {
    flex-direction: column;
  }
  #sidebar {
    width: 100vw;
    min-width: 0;
    border-radius: 0;
    box-shadow: none;
  }
  #sidebar h2 {
    border-radius: 0;
  }
  #chatList {
    border-radius: 0;
    max-height: 120px;
    flex-shrink: 1;
  }
  #chatArea {
    min-width: 0;
  }
}
@media (max-width: 500px) {
  #wrapper {
    border-radius: 0 !important;
    box-shadow: none !important;
  }
  #header {
    font-size: 17px;
    padding: 11px 7px 6px 7px;
    border-radius: 0 0 8px 8px;
  }
  .msgBubble {
    font-size: 13px;
    padding: 6px 9px;
    max-width: 95vw;
    border-radius: 10px 10px 4px 10px;
  }
  #inputBar {
    padding: 5px 1vw 5px 1vw;
    border-radius: 8px 8px 0 0;
    gap: 5px;
  }
  #messageInput {
    font-size: 13px;
    padding: 6px;
    border-radius: 10px;
  }
  #sendBtn {
    font-size: 13px;
    padding: 5px 10px;
    border-radius: 10px;
  }
  .lastMsg {
    max-width: 90vw;
  }
}
  </style>
</head>
<body>
  <div id="wrapper">
    <div id="sidebar">
      <div id="sidebarHeader">
        <h2>Chats</h2>
        <div id="sidebarSearchBar">
          <input id="sidebarSearchInput" placeholder="Search chats..." type="text" />
        </div>
      </div>
      <div id="chatList"></div>
    </div>
    <div id="chatArea">
      <div id="header">
        <span id="chatWith">Select a chat</span>
        <div id="msgSearchBar">
          <input id="msgSearchInput" placeholder="Search messages..." type="text" />
        </div>
      </div>
      <div id="messages"></div>
      <div id="inputBar" style="display: none;">
        <input type="text" id="messageInput" placeholder="Type your message..." autocomplete="off" />
        <button id="sendBtn">Send</button>
      </div>
      <div id="noChat">Select a chat to start messaging</div>
    </div>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc, updateDoc, serverTimestamp, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDXuxaO1WKLAWGVLXcVb2Q6XX_UGcTKPo0",
      authDomain: "merg-online-store.firebaseapp.com",
      projectId: "merg-online-store",
      storageBucket: "merg-online-store.appspot.com",
      messagingSenderId: "1096457005407",
      appId: "1:1096457005407:web:64fb56790dad61b962aeea",
      measurementId: "G-V6WM36V9BD"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const adminId = "admin_1";
    const adminName = "Admin";

    let selectedConversation = null;
    let selectedClientName = null;
    let unsubscribeMessages = null;
    let allMessages = [];
    let allConversations = [];

    const chatListDiv = document.getElementById("chatList");
    const messagesDiv = document.getElementById("messages");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const chatWithTitle = document.getElementById("chatWith");
    const inputBar = document.getElementById("inputBar");
    const noChat = document.getElementById("noChat");
    const sidebarSearchInput = document.getElementById("sidebarSearchInput");
    const msgSearchInput = document.getElementById("msgSearchInput");

    // Format timestamp to HH:mm
    function formatTime(ts) {
      if (!ts) return '';
      const date = ts.toDate ? ts.toDate() : new Date(ts);
      return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    // Helper: Get the latest message from a conversation's messages subcollection
    async function getLastMessageForConvo(convoId) {
      const msgsQuery = query(
        collection(db, "conversations", convoId, "messages"),
        orderBy("createdAt", "desc"),
        limit(1)
      );
      const snap = await getDocs(msgsQuery);
      if (!snap.empty) {
        const data = snap.docs[0].data();
        return {
          text: data.text,
          senderId: data.senderId,
          senderName: data.senderName,
          createdAt: data.createdAt,
        };
      }
      return null;
    }

    // Render chat list, with optional filter
    function renderChatList(filter) {
      chatListDiv.innerHTML = "";
      (filter || allConversations).forEach(({convo, convoId, lastMessageObj}) => {
        // Show last sender's name and message
        let lastMsgText = "";
        if (lastMessageObj) {
          lastMsgText = (lastMessageObj.senderName || "Unknown") + ": " + (lastMessageObj.text ? lastMessageObj.text.slice(0,40) : "");
        } else if (convo.lastMessage) {
          // fallback if not loaded from subcollection
          lastMsgText = (convo.lastSender || "Unknown") + ": " + convo.lastMessage.slice(0,40);
        }
        const chatItem = document.createElement("div");
        chatItem.className = "chatItem" + (selectedConversation === convoId ? " active" : "");
        chatItem.onclick = () => selectConversation(convoId, convo.clientName);
        chatItem.innerHTML = `
          <div class="chatName">${convo.clientName || "Unknown User"}</div>
          <div class="lastMsg">${lastMsgText}</div>
          ${convo.unreadForAdmin ? '<span class="badge">New</span>' : ""}
        `;
        chatListDiv.appendChild(chatItem);
      });
    }

    // Listen for all conversations (with latest message and sort)
    onSnapshot(
      query(collection(db, "conversations"), orderBy("lastTimestamp", "desc")),
      async (snapshot) => {
        // For each conversation, get its last message (from messages subcollection)
        const promises = [];
        const newConvos = [];
        snapshot.forEach(docSnap => {
          const convo = docSnap.data();
          const convoId = docSnap.id;
          const promise = getLastMessageForConvo(convoId).then(lastMessageObj => {
            newConvos.push({convo, convoId, lastMessageObj});
          });
          promises.push(promise);
        });
        await Promise.all(promises);
        // Sort with latest message at the top (by timestamp)
        newConvos.sort((a, b) => {
          const aTime = a.lastMessageObj && a.lastMessageObj.createdAt ? a.lastMessageObj.createdAt.toMillis ? a.lastMessageObj.createdAt.toMillis() : new Date(a.lastMessageObj.createdAt).getTime() : 0;
          const bTime = b.lastMessageObj && b.lastMessageObj.createdAt ? b.lastMessageObj.createdAt.toMillis ? b.lastMessageObj.createdAt.toMillis() : new Date(b.lastMessageObj.createdAt).getTime() : 0;
          return bTime - aTime;
        });
        allConversations = newConvos;
        renderChatList();
      }
    );

    // Sidebar chat search
    sidebarSearchInput.addEventListener("input", (e) => {
      const q = e.target.value.trim().toLowerCase();
      if (!q) {
        renderChatList();
      } else {
        const filtered = allConversations.filter(({convo, lastMessageObj}) =>
          (convo.clientName || "").toLowerCase().includes(q) ||
          (lastMessageObj && (lastMessageObj.text || "").toLowerCase().includes(q))
        );
        renderChatList(filtered);
      }
    });

    // Select a conversation
    function selectConversation(convoId, clientName) {
      selectedConversation = convoId;
      selectedClientName = clientName;
      chatWithTitle.textContent = "Chat with " + (clientName || "Unknown User");
      inputBar.style.display = "";
      noChat.style.display = "none";
      messagesDiv.innerHTML = "";
      msgSearchInput.value = "";
      // Mark as read for admin
      updateDoc(doc(db, "conversations", convoId), { unreadForAdmin: false });

      // Listen for new messages
      if (unsubscribeMessages) unsubscribeMessages();
      const messagesQuery = query(
        collection(db, "conversations", convoId, "messages"),
        orderBy("createdAt", "asc")
      );
      unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
        allMessages = [];
        snapshot.forEach(docSnap => {
          allMessages.push(docSnap.data());
        });
        renderMessages();
      });
    }

    // Render messages, optionally filtered
    function renderMessages(filtered) {
      messagesDiv.innerHTML = "";
      (filtered || allMessages).forEach(msg => {
        const isMine = msg.senderId === adminId;
        const msgRow = document.createElement("div");
        msgRow.className = "msgRow" + (isMine ? " mine" : "");
        const msgDiv = document.createElement("div");
        msgDiv.className = "msgBubble";
        msgDiv.textContent = msg.text;
        msgRow.appendChild(msgDiv);
        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = formatTime(msg.createdAt) || '';
        msgRow.appendChild(meta);
        messagesDiv.appendChild(msgRow);
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Message search
    msgSearchInput.addEventListener("input", (e) => {
      const q = e.target.value.trim().toLowerCase();
      if (!q) {
        renderMessages();
      } else {
        const filtered = allMessages.filter(m => (m.text || "").toLowerCase().includes(q));
        renderMessages(filtered);
      }
    });

    // Send message
    async function sendMessage() {
      const text = messageInput.value.trim();
      if (!text || !selectedConversation) return;
      await addDoc(
        collection(db, "conversations", selectedConversation, "messages"),
        {
          text,
          senderId: adminId,
          senderName: adminName,
          createdAt: serverTimestamp()
        }
      );
      // Update conversation meta
      await setDoc(doc(db, "conversations", selectedConversation), {
        lastMessage: text,
        lastSender: adminName,
        lastTimestamp: serverTimestamp(),
        unreadForClient: true // new message for client
      }, { merge: true });
      messageInput.value = "";
    }

    sendBtn.addEventListener("click", sendMessage);
    messageInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendMessage();
    });
  </script>
</body>
</html>