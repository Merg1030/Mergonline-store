<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Your Orders - MergSignature Jewelry</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #c9d6e5;
      color: #222;
      margin: 0;
      font-size: 13px;
    }
    .container {
      max-width: 100vw;
      margin: 0 auto;
      background: #f7f9fa;
      border-radius: 8px;
      box-shadow: 0 2px 10px #3574e71a;
      padding: 0.3rem 0.1rem 0.7rem 0.1rem;
    }
    h2 {
      font-size: 1.08em;
      margin: 0.25em 0 0.9em 0;
      text-align: center;
      color: #3574e7;
      letter-spacing: 1px;
      font-weight: bold;
      text-shadow: 0 2px 6px #3574e71a;
    }
    .filter-bar {
      margin: 0 0 1em 0;
      display: flex;
      align-items: center;
      gap: 0.45em;
      flex-wrap: wrap;
      justify-content: center;
      background: #e2e6ef;
      border-radius: 8px;
      padding: 0.42em 0.5em 0.42em 0.5em;
      box-shadow: 0 1px 2px #3574e711;
    }
    .filter-bar label {
      font-weight: 600;
      color: #3574e7;
      font-size: .96em;
      letter-spacing: 0.5px;
    }
    .filter-bar input[type="date"] {
      padding: 0.11em 0.42em;
      border-radius: 4px;
      border: 1px solid #b2d4f7;
      font-size: .97em;
      background: #fff;
      color: #1d2636;
      outline: none;
      transition: border 0.15s;
    }
    .filter-bar input[type="date"]:focus {
      border: 1.5px solid #3574e7;
    }
    #clearDateFilter {
      padding:0.15em 0.7em;
      border-radius:4px;
      border:1px solid #3574e7;
      background: #fff;
      color:#3574e7;
      font-weight:600;
      cursor:pointer;
      font-size:.97em;
      transition: background 0.18s, color 0.18s;
    }
    #clearDateFilter:hover {
      background: #3574e7;
      color: #fff;
    }
    .order-list {
      margin: 0;
      padding: 0;
      list-style: none;
    }
    .order-card {
      border: 1px solid #b2d4f7;
      border-radius: 7px;
      background: #fff;
      margin-bottom: 1rem;
      padding: 0.4rem 0.5rem 0.35rem 0.5rem;
      box-shadow: 0 1px 6px #3574e711;
      position: relative;
      font-size: .98em;
      transition: box-shadow 0.18s;
    }
    .order-card:hover {
      box-shadow: 0 3px 18px #3574e735;
      border-color: #3574e7;
    }
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .order-id {
      font-weight: 600;
      color: #3574e7;
      font-size: 1.04em;
      letter-spacing: 0.15em;
    }
    .order-status {
      font-weight: 600;
      text-transform: capitalize;
      padding: 0.09em 0.5em;
      border-radius: 14px;
      font-size: .98em;
      background: #e2e6ef;
      color: #3574e7;
      border: 1.2px solid #b2d4f7;
      min-width: 76px;
      text-align: center;
      box-shadow: 0 1px 2px #3574e711;
      letter-spacing: 0.5px;
    }
    .order-status.pending {
      background: #fff3cd;
      color: #ad7c00;
      border-color: #ffe082;
    }
    .order-status.waiting {
      background: #e0e5ff;
      color: #2e4f9b;
      border-color: #b6c0ff;
    }
    .order-status.paid {
      background: #e3f6da;
      color: #2e7d32;
      border-color: #b2dfdb;
    }
    .order-status.completed, .order-status.closed {
      background: #e0ffe2;
      color: #107b3b;
      border-color: #b2dfdb;
    }
    .order-status.cancelled {
      background: #ffd1d1;
      color: #c62828;
      border-color: #ffcdd2;
    }
    .order-date {
      color: #5e89d8;
      font-size: 0.95em;
      margin-bottom: 3px;
      margin-top: 2px;
    }
    .order-items {
      margin: 0.38em 0 0.3em 0;
      padding-left: 0.8em;
    }
    .order-items li {
      margin-bottom: 0.11em;
      font-size:0.98em;
    }
    .order-total {
      font-weight: 600;
      color: #1d2636;
      font-size:1.01em;
      margin-bottom: 2px;
    }
    .order-proof {
      margin-top: .22em;
    }
    .order-proof img {
      max-width: 48px;
      max-height: 48px;
      border-radius: 3px;
      border: 1px solid #b2d4f7;
      box-shadow: 0 1px 3px #3574e711;
    }
    .order-location {
      margin-top: .15em;
      color: #3574e7;
      font-size: .97em;
      font-weight: 600;
    }
    .order-location-label {
      color: #444;
      font-weight: 600;
    }
    .order-review-box {
      margin-top: 0.48em;
      background: #f6f8fd;
      border-radius: 4px;
      border: 1.2px solid #b2d4f7;
      padding: 0.18em 0.2em 0.13em 0.2em;
    }
    .review-label {
      color: #3574e7;
      font-weight: 600;
      font-size:1em;
    }
    .review-textarea {
      width: 97%;
      min-height: 22px;
      border-radius: 3px;
      border: 1px solid #bbb;
      margin: .13em 0 .1em 0;
      font-size: 0.98em;
      padding: 0.12em 0.15em;
      background: #fff;
      color: #1d2636;
      transition: border 0.16s;
    }
    .review-textarea:focus {
      border: 1.5px solid #3574e7;
      background: #f7f9fa;
    }
    .review-btn {
      background: #3574e7;
      color: #fff;
      border: none;
      border-radius: 3px;
      padding: 0.17em 0.9em;
      font-size: 1em;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 1px 3px #3574e711;
      transition: background 0.16s, color 0.16s;
    }
    .review-btn:hover {
      background: #2554a7;
      color: #fff;
    }
    .review-msg {
      color: #107b3b;
      font-size: 0.97em;
      margin-top: 0.11em;
    }
    .review-view {
      margin-top: 0.23em;
      color: #111;
      font-size: 1em;
      background: #f6f8fd;
      border-radius: 3px;
      border: 1.2px solid #b2d4f7;
      padding: 0.13em 0.18em;
    }
    .order-receipt-btn {
      background: #2e6aaf;
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 7px 20px;
      margin-top: 10px;
      font-size: 1em;
      cursor: pointer;
      font-weight: 600;
      transition: background .18s;
      box-shadow: 0 2px 8px #3574e711;
      display: block;
    }
    .order-receipt-btn:hover {
      background: #18406a;
    }
    .empty-msg {
      color: #888;
      text-align: center;
      margin: 1.6rem;
      font-size:1em;
    }
    .back-link {
      display: block;
      text-align: center;
      margin-top: 0.7rem;
      color: #3574e7;
      text-decoration: none;
      font-size: 1em;
      font-weight: 600;
      transition: color 0.16s;
    }
    .back-link:hover {
      color: #2554a7;
      text-decoration: underline;
    }
    @media (max-width: 600px) {
      .container {
        padding: 0.10rem;
        border-radius: 3px;
      }
      h2 {
        font-size: 1em;
        margin: 0.25em 0 0.6em 0;
      }
      .order-card {
        padding: 0.22rem 0.12rem 0.22rem 0.12rem;
        border-radius: 4px;
      }
      .filter-bar {
        flex-direction: column;
        align-items: stretch;
        gap: 0.32em;
        padding: 0.21em 2vw 0.21em 2vw;
        border-radius: 4px;
      }
      .order-proof img {
        max-width: 33px;
        max-height: 33px;
      }
      .order-id {
        font-size:0.96em;
      }
      .order-status {
        font-size: .96em;
        min-width: 66px;
        border-radius: 8px;
        padding: 0.06em 0.22em;
      }
      .order-date {
        font-size: .93em;
      }
      .order-items li {
        font-size: 0.97em;
      }
      .order-total {
        font-size: .97em;
      }
      .order-location {
        font-size: .96em;
      }
      .review-label,
      .review-view {
        font-size: 0.98em;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Your Orders</h2>
    <div class="filter-bar">
      <label for="dateFilter">Date:</label>
      <input type="date" id="dateFilter" />
      <button id="clearDateFilter" style="padding:0.13em 0.5em; border-radius:3px; border:1px solid #ccc; background:#f2f2f2; color:#3574e7; font-weight:600; cursor:pointer; font-size:.94em;">All</button>
    </div>
    <ul class="order-list" id="orderList"></ul>
    <div class="empty-msg" id="emptyMsg" style="display:none;">No orders found yet.</div>
    <a href="index.html" class="back-link">&larr; Shop</a>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDXuxaO1WKLAWGVLXcVb2Q6XX_UGcTKPo0",
      authDomain: "merg-online-store.firebaseapp.com",
      projectId: "merg-online-store",
      storageBucket: "merg-online-store.appspot.com",
      messagingSenderId: "1096457005407",
      appId: "1:1096457005407:web:64fb56790dad61b962aeea",
      measurementId: "G-V6WM36V9BD"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const ordersRef = collection(db, "orders");

    const orderList = document.getElementById('orderList');
    const emptyMsg = document.getElementById('emptyMsg');
    const dateFilter = document.getElementById('dateFilter');
    const clearDateFilterBtn = document.getElementById('clearDateFilter');
    const DATE_STORAGE_KEY = "mergsignature_order_datefilter";

    // --- Persist date filter
    if(localStorage.getItem(DATE_STORAGE_KEY)){
      dateFilter.value = localStorage.getItem(DATE_STORAGE_KEY);
    }
    dateFilter.addEventListener('change', function() {
      if(dateFilter.value){
        localStorage.setItem(DATE_STORAGE_KEY, dateFilter.value);
      } else {
        localStorage.removeItem(DATE_STORAGE_KEY);
      }
      renderOrders();
    });
    clearDateFilterBtn.addEventListener('click', function(){
      dateFilter.value = "";
      localStorage.removeItem(DATE_STORAGE_KEY);
      renderOrders();
    });

    let allUserOrders = [];
    let userUID = null;
    let unsubscribe = null;

    onAuthStateChanged(auth, user => {
      if (!user) {
        orderList.innerHTML = '';
        emptyMsg.textContent = 'You must be logged in to see your orders.';
        emptyMsg.style.display = '';
        return;
      }
      userUID = user.uid;
      if (unsubscribe) unsubscribe();
      unsubscribe = onSnapshot(ordersRef, (snap) => {
        allUserOrders = snap.docs
          .map(doc => ({ ...doc.data(), id: doc.id }))
          .filter(order => order.uid === user.uid)
          .sort((a,b) => {
            if (a.date && b.date) return new Date(b.date) - new Date(a.date);
            return 0;
          });
        renderOrders();
      });
    });

    // Helper: Convert "6/12/2025, 3:15:25 PM" to "2025-06-12"
    function toISODate(str) {
      if (!str) return "";
      const d = new Date(str);
      if (isNaN(d.getTime())) return "";
      return d.toISOString().slice(0,10);
    }

    // Helper: Format date as "DD.MM.YYYY"
    function toNiceDate(str) {
      if (!str) return "";
      const d = new Date(str);
      if (isNaN(d.getTime())) return "";
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yyyy = d.getFullYear();
      return `${dd}.${mm}.${yyyy}`;
    }

    function renderOrders() {
      let orders = allUserOrders.slice();
      const selectedDate = dateFilter.value;
      if(selectedDate) {
        orders = orders.filter(order => {
          if(!order.date) return false;
          return toISODate(order.date) === selectedDate;
        });
      }
      orderList.innerHTML = '';
      if (orders.length === 0) {
        emptyMsg.textContent = selectedDate ? 'No orders found for selected date.' : 'No orders found yet.';
        emptyMsg.style.display = '';
        return;
      }
      emptyMsg.style.display = 'none';
      orders.forEach(order => {
        const statusClass = getStatusClass(order.status);
        let statusText = getStatusText(order.status);
        let reviewSection = "";

        // Show review form if order is completed/closed and no review yet
        if((order.status==="completed"||order.status==="closed") && !order.review){
          reviewSection = `
            <div class="order-review-box" id="reviewBox-${order.id}">
              <span class="review-label">Write a review:</span>
              <textarea class="review-textarea" id="reviewText-${order.id}" maxlength="300" placeholder="How was your order?"></textarea>
              <button class="review-btn" onclick="window.submitReview('${order.id}')">Send</button>
              <div class="review-msg" id="reviewMsg-${order.id}" style="display:none;"></div>
            </div>
          `;
        } else if(order.review) {
          reviewSection = `<div class="review-view"><b>Your Review:</b> ${escapeHTML(order.review)}</div>`;
        }

        // Different display for proof and status
        let proofHtml = "";
        if(order.proof){
          proofHtml = `<div class="order-proof"><b>Proof:</b><br><img src="${order.proof}"></div>`;
        }

        orderList.innerHTML += `
          <li class="order-card" id="orderCard-${order.id}">
            <div class="order-header">
              <span class="order-id">Order #${order.id.slice(0,8).toUpperCase()}</span>
              <span class="order-status ${statusClass}">${statusText}</span>
            </div>
            <div class="order-date">${order.date ? toNiceDate(order.date) : ""}</div>
            <ul class="order-items">
              ${order.items.map(item => `<li>${item.name} (x${item.qty}) - ZMW ${(item.price*item.qty).toFixed(2)}</li>`).join('')}
            </ul>
            <div class="order-total">Total: ZMW ${order.total ? order.total.toFixed(2) : "0.00"}</div>
            <div class="order-location">
              <span class="order-location-label">Delivery:</span>
              ${order.deliveryLocation ? order.deliveryLocation : '<span style="color:#e74c3c;">Not Provided</span>'}
            </div>
            <button class="order-receipt-btn" onclick="window.showReceipt('${order.id}')">View Receipt</button>
            ${proofHtml}
            ${renderStatusNote(order)}
            ${reviewSection}
          </li>
        `;
      });
      // Attach review submit handlers after rendering
      orders.forEach(order=>{
        if((order.status==="completed"||order.status==="closed") && !order.review){
          const btn = document.querySelector(`#orderCard-${order.id} .review-btn`);
          if(btn){
            btn.onclick = ()=>submitReview(order.id);
          }
        }
      });
    }

    function getStatusClass(status){
      if(!status) return "pending";
      status = status.toLowerCase();
      if(status==="waiting"||status==="waiting for verification") return "waiting";
      if(status==="pending") return "pending";
      if(status==="paid") return "paid";
      if(status==="completed"||status==="closed") return "completed";
      if(status==="cancelled") return "cancelled";
      return "";
    }
    function getStatusText(status){
      if(!status) return "Pending";
      if(status.toLowerCase()==="waiting"||status.toLowerCase()==="waiting for verification") return "Waiting for Verification";
      if(status.toLowerCase()==="pending") return "Pending";
      if(status.toLowerCase()==="paid") return "Paid";
      if(status.toLowerCase()==="completed"||status.toLowerCase()==="closed") return "Order Closed";
      if(status.toLowerCase()==="cancelled") return "Cancelled";
      return status.charAt(0).toUpperCase()+status.slice(1);
    }
    function renderStatusNote(order){
      if(order.status==="waiting"||order.status==="waiting for verification"){
        return `<div style="color:#2e4f9b; margin-top:0.13em;font-size:.92em;">Payment uploaded. Waiting for admin verification.</div>`;
      }
      if(order.status==="paid"){
        return `<div style="color:#2e7d32; margin-top:0.13em;font-size:.92em;">Payment verified. Awaiting delivery.</div>`;
      }
      if(order.status==="completed"||order.status==="closed"){
        return `<div style="color:#107b3b; margin-top:0.13em;font-size:.92em;">Order closed. Thank you!</div>`;
      }
      return "";
    }
    // --- Secure HTML escaping for user review
    function escapeHTML(str){
      return (str||"").replace(/[&<>"']/g, function(m) {
        return {"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m];
      });
    }
    // --- Review submission
    window.submitReview = async function(orderId){
      const textarea = document.getElementById(`reviewText-${orderId}`);
      const msg = document.getElementById(`reviewMsg-${orderId}`);
      if(!textarea) return;
      const text = textarea.value.trim();
      if(text.length < 5){
        msg.textContent = "Please write a short review (min 5 chars)";
        msg.style.display = 'block';
        return;
      }
      msg.textContent = "Saving...";
      msg.style.display = 'block';
      try {
        await setDoc(doc(ordersRef, orderId), { review: text }, { merge: true });
        msg.textContent = "Review submitted!";
        setTimeout(()=>{ renderOrders(); }, 900);
      } catch(e){
        msg.textContent = "Error saving review. Try again.";
      }
    }

    // --- Receipt Generator
    window.showReceipt = function(orderId) {
      const order = allUserOrders.find(o => o.id === orderId);
      if(!order) return alert("Order not found!");

      // Compose items HTML
      let itemsHtml = (order.items && Array.isArray(order.items)) ? order.items.map(item => `
        <tr>
          <td>${item.name}</td>
          <td>${item.qty}</td>
          <td>${(item.price).toFixed(2)}</td>
          <td>${(item.price * item.qty).toFixed(2)}</td>
        </tr>
      `).join('') : '';

      // Try to get customer name/email from order, fallback to empty
      const customerName = order.customerName || order.name || "Customer";
      const customerEmail = order.customerEmail || order.email || "";

      // TID and delivery address
      const tid = order.tid || order.paymentId || order.transactionId || "";
      const deliveryAddress = order.deliveryLocation || order.address || "";

      // Format date as DD.MM.YYYY
      const onlyDate = order.date ? toNiceDate(order.date) : "";

      // Receipt markup
      const receiptHtml = `
      <!DOCTYPE html>
      <html lang="en">
      <head>
        <meta charset="UTF-8">
        <title>Receipt - mergsignature</title>
        <style>
          @page { size: A4; margin: 20mm; }
          body { font-family: 'Segoe UI', Arial, sans-serif; background: #fff; margin: 0; padding: 0;}
          .a4-container { width: 210mm; min-height: 297mm; margin: 0 auto; background: #fff; padding: 32px 24px; box-sizing: border-box; }
          .brand { text-align: center; font-weight: bold; font-size: 2.2rem; color: #2e6aaf; letter-spacing: 2.5px; margin-bottom: 6px; margin-top: 10px; }
          .contact { text-align: center; margin-bottom: 26px; color: #18406a; font-size: 1.08rem; line-height: 1.7; }
          .contact span { display: inline-block; margin: 0 10px; }
          h2 { text-align: center; margin: 0 0 24px 0; color: #222; letter-spacing: 1.5px; font-size: 2rem; }
          .receipt-details { width: 100%; margin-bottom: 24px; font-size: 1.07rem; }
          .receipt-details td { padding: 6px 0; color: #333; }
          .items { width: 100%; border-collapse: collapse; margin-bottom: 24px; }
          .items th, .items td { border: 1px solid #e0e0e0; padding: 10px 8px; text-align: left; }
          .items th { background: #f0f4f8; color: #2e6aaf; }
          .total-label { text-align: right; font-size: 1.13rem; padding-right: 8px; font-weight: bold; }
          .total-value { font-size: 1.13rem; font-weight: bold; color: #18406a; padding-left: 8px; }
          .footer { margin-top: 40px; text-align: center; font-size: 1rem; color: #888; }
          .print-btn { display: inline-block; margin: 30px auto 0 auto; padding: 14px 44px; background: #2e6aaf; color: #fff; border: none; border-radius: 6px; font-size: 1.10rem; cursor: pointer; transition: background .2s; box-shadow: 0 2px 8px rgba(46,106,175,0.06);}
          .print-btn:hover { background: #18406a; }
          @media print { .print-btn, .footer { display: none !important; } body { background: #fff; } .a4-container { box-shadow: none; margin: 0; padding: 0; } }
        </style>
      </head>
      <body>
        <div class="a4-container">
          <div class="brand">mergsignature</div>
          <div class="contact">
            <span><b>Customer Care:</b></span>
            <span>0771287206</span>
            <span>0777290456</span> <br>
            <span><b>Email:</b> mergsignature@gmail.com</span>
          </div>
          <h2>RECEIPT</h2>
          <table class="receipt-details">
            <tr>
              <td><b>Receipt #:</b></td>
              <td>${order.id.slice(0,10).toUpperCase()}</td>
              <td><b>Date:</b></td>
              <td>${onlyDate}</td>
            </tr>
            <tr>
              <td><b>Billed To:</b></td>
              <td>${customerName}</td>
              <td><b>Email:</b></td>
              <td>${customerEmail}</td>
            </tr>
            <tr>
              <td><b>TID:</b></td>
              <td>${tid}</td>
              <td><b>Delivery Address:</b></td>
              <td>${deliveryAddress}</td>
            </tr>
          </table>
          <table class="items">
            <tr>
              <th>Item Description</th>
              <th>Qty</th>
              <th>Unit Price (ZMW)</th>
              <th>Amount (ZMW)</th>
            </tr>
            ${itemsHtml}
            <tr>
              <td colspan="3" class="total-label">Total (ZMW)</td>
              <td class="total-value">${order.total ? order.total.toFixed(2) : "0.00"}</td>
            </tr>
          </table>
          <button class="print-btn" onclick="window.print()">Print Receipt</button>
          <div class="footer">
            Thank you for choosing mergsignature!<br>
            www.mergsignature.com | support@mergsignature.com
          </div>
        </div>
      </body>
      </html>
      `;
      // Open in new window for printing
      const w = window.open("", "_blank", "width=800,height=1000");
      w.document.write(receiptHtml);
      w.document.close();
    };

    // Inactivity timeout, security, etc.
    let inactivityTimeout;
    function resetInactivityTimeout() {
        clearTimeout(inactivityTimeout);
        inactivityTimeout = setTimeout(() => {
            logout();
        }, 600000); // 10 minutes
    }

    resetInactivityTimeout();
    document.addEventListener('mousemove', resetInactivityTimeout);
    document.addEventListener('keypress', resetInactivityTimeout);
    document.addEventListener('click', resetInactivityTimeout);
    document.addEventListener('touchstart', resetInactivityTimeout);

    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
    });

    document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey && (e.key === 'u' || e.key === 's' || e.key === 'a' || e.key === 'c')) || e.key === 'F12') {
            e.preventDefault();
        }
    });
  </script>
</body>
</html>
